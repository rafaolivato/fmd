datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id               String          @id @default(uuid())
  email            String          @unique
  password         String
  name             String
  role             String          @default("farmaceutico") // 'admin', 'farmaceutico', 'almoxarife'
  estabelecimentoId String?
  estabelecimento  Estabelecimento? @relation(fields: [estabelecimentoId], references: [id])
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

}

model Medicamento {
  id                String            @id @default(uuid())
  principioAtivo    String            @unique
  concentracao      String
  formaFarmaceutica String
  psicotropico      Boolean           @default(false)
  categoriaControladaId String?
  categoriaControlada   CategoriaControlada? @relation(fields: [categoriaControladaId], references: [id])
  quantidadeEstoque Int               @default(0) // Estoque total, independente do lote
  estoqueMinimo     Int     @default(100)
  itensMovimentados ItemMovimento[] // Indica que um Medicamento pode ter muitos ItemMovimento
  itensDispensados  ItemDispensacao[]
  estoqueLocal      EstoqueLocal[] // Referência inversa de EstoqueLocal
  estoqueLotes EstoqueLote[]  // Campo inverso da relação
  itensRequisicao   ItemRequisicao[] // Referência inversa de ItemRequisicao
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([categoriaControladaId])
  @@index([psicotropico])

}

model CategoriaControlada {
  id          String   @id @default(uuid())
  nome        String   @unique  // "PSICOTRÓPICO", "ENTORPECENTE", "ANTIMICROBIANO"
  tipo        String?           // "A1", "A2", "A3", "B1", "B2", "C1", etc.
  descricao   String?
  
  medicamentos Medicamento[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Movimento {
  id String @id @default(uuid())

  // DADOS DA TRANSAÇÃO GERAL
  tipoMovimentacao   String // Ex: Entrada Ordinária, Ajuste de Estoque
  fonteFinanciamento String // Ex: Municipal, Estadual + Federal
  fornecedorId String?
 
  documentoTipo      String // Ex: Nota Fiscal, Nota de Simples Remessa
  numeroDocumento    String   @unique // Chave única para o documento
  dataDocumento      DateTime
  dataRecebimento    DateTime
  valorTotal         Float
  observacao         String?
  
  estabelecimentoId String
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id])
  fornecedor   Fornecedor? @relation(fields: [fornecedorId], references: [id], onDelete: SetNull)

  // Relação com os Itens desta movimentação
  itensMovimentados ItemMovimento[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt


}

model ItemMovimento {
  id String @id @default(uuid())

  // DADOS ESPECÍFICOS DO ITEM/LOTE
  valorUnitario     Float
  fabricante        String // Fabricante (pode ser diferente do Fornecedor/Distribuidor)
  numeroLote        String
  dataValidade      DateTime
  quantidade        Int
  localizacaoFisica String // Ex: Prateleira A, Armário 1

  // RELACIONAMENTO COM MEDICAMENTO (O ITEM que está sendo movimentado)
  medicamentoId String
  medicamento   Medicamento @relation(fields: [medicamentoId], references: [id])

  // RELACIONAMENTO COM O MOVIMENTO (O DOCUMENTO ao qual pertence)
  movimentoId String
  movimento   Movimento @relation(fields: [movimentoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Garante que não se insira o mesmo lote no mesmo documento
  @@unique([numeroLote, movimentoId])
}

model Paciente {
  id          String @id @default(uuid())
  nome        String
  cpf         String @unique
  dataNascimento DateTime
  endereco     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Dispensacao {
  id String @id @default(uuid())

  // DADOS DA SAÍDA GERAL (Receituário)
  pacienteNome        String
  pacienteCpf         String? // Opcional, dependendo da regra
  profissionalSaudeId     String?  // ID do profissional cadastrado
  profissionalSaude       ProfissionalSaude? @relation(fields: [profissionalSaudeId], references: [id])
  profissionalSaudeNome   String? // Nome livre para quando não houver cadastro
  documentoReferencia String // Ex: Número do Receituário, Prontuário
  dataDispensacao     DateTime @default(now())
  observacao          String?

  // Relação com os itens que foram dispensados
  itensDispensados ItemDispensacao[]

  justificativaRetiradaAntecipada String?
  usuarioAutorizador              String?
  dataAutorizacao                 DateTime?

  estabelecimentoOrigemId String
  estabelecimentoOrigem   Estabelecimento @relation("DispensacaoOrigem", fields: [estabelecimentoOrigemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dispensacoes")
}

model ItemDispensacao {
  id String @id @default(uuid())

  // DADOS ESPECÍFICOS DO ITEM DISPENSADO
  quantidadeSaida Int // Quantidade que está saindo (sempre positiva)

  // O lote que foi consumido
  loteNumero String // Guardamos o LOTE que foi dispensado (para registro)

  // RELACIONAMENTO COM MEDICAMENTO
  medicamentoId String
  medicamento   Medicamento @relation(fields: [medicamentoId], references: [id])

  // RELACIONAMENTO COM A DISPENSAÇÃO
  dispensacaoId String
  dispensacao   Dispensacao @relation(fields: [dispensacaoId], references: [id])

  isControlado Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relação inversa no Medicamento:
  // @relation(name: "DispensacaoDeItens")

  @@map("itens_dispensacao")
}

model ProfissionalSaude {
  id        String   @id @default(uuid())
  nome      String   @unique
  crm       String?  // ou outro registro profissional
  
  // Relações
  dispensacoes Dispensacao[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("profissionais_saude")
}


model Estabelecimento {
  id   String  @id @default(uuid())
  nome String  @unique
  cnes String? @unique // Cadastro Nacional de Estabelecimentos de Saúde (até 7 dígitos)
  tipo String // Ex: 'ALMOXARIFADO', 'FARMACIA_UNIDADE'

  usuarios     User[]

  // RELACIONAMENTOS INVERSOS:
  solicitacoes Requisicao[] @relation("Solicitante")
  atendimentos Requisicao[] @relation("Atendente")
  estoqueLotes EstoqueLote[]  // Campo inverso da relação

  // Nova tabela para Estoque por Local (ver item B)
  estoqueLocal EstoqueLocal[]

  saidasDispensacao Dispensacao[] @relation("DispensacaoOrigem")

  movimentos Movimento[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EstoqueLocal {
  id         String @id @default(uuid())
  quantidade Int

  // Quem é o medicamento
  medicamentoId String
  medicamento   Medicamento @relation(fields: [medicamentoId], references: [id])

  // Onde ele está
  estabelecimentoId String
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Chave Única para garantir apenas um saldo por medicamento/estabelecimento
  @@unique([medicamentoId, estabelecimentoId])
}

model Requisicao {
  id String @id @default(uuid())

  // Solicitante (Farmácia de destino)
  solicitanteId String
  solicitante   Estabelecimento @relation("Solicitante", fields: [solicitanteId], references: [id], onDelete: Cascade)

  // Atendente (Almoxarifado/Estabelecimento de origem)
  atendenteId String
  atendente   Estabelecimento @relation("Atendente", fields: [atendenteId], references: [id], onDelete: Cascade)

  status          String   @default("PENDENTE") // Ex: 'PENDENTE', 'EM_SEPARACAO', 'ATENDIDA', 'CANCELADA'
  dataSolicitacao DateTime @default(now())
  dataAtendimento DateTime?
  observacoes     String?

  itens ItemRequisicao[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ItemRequisicao {
  id                   String @id @default(uuid())
  quantidadeSolicitada Int
  quantidadeAtendida   Int    @default(0) // Quanto do solicitado foi enviado

  medicamentoId String
  medicamento   Medicamento @relation(fields: [medicamentoId], references: [id])

  requisicaoId String
  requisicao   Requisicao @relation(fields: [requisicaoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model EstoqueLote {
  id String @id @default(uuid())

  // RELAÇÕES
  medicamentoId String
  medicamento Medicamento @relation(fields: [medicamentoId], references: [id])

  estabelecimentoId String
  estabelecimento Estabelecimento @relation(fields: [estabelecimentoId], references: [id])

  // DADOS DO LOTE (para busca FIFO)
  quantidade Int @default(0) // SALDO ATUAL DO LOTE (o que será baixado)
  numeroLote String
  dataValidade DateTime
  fabricante String

  valorUnitario Decimal @default(0) @db.Decimal(10, 2)

  // CAMPOS DE RASTREABILIDADE
  itemMovimentoEntradaId String? // Opcional: Para saber qual ItemMovimento deu origem a este saldo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Garante que só haja um registro de um lote específico em um estabelecimento
  @@unique([medicamentoId, estabelecimentoId, numeroLote])
}

model Fornecedor {
  id        String   @id @default(uuid())
  nome      String
  cnpj      String   @unique
  telefone  String?
  email     String?
  endereco  String?
  ativo     Boolean  @default(true)
  
  movimentos Movimento[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fornecedores")
}

